# 数据大屏

项目描述：数据大屏是 PC 端的数据可视化平台，提供实时数据可视化与分钟级数据追踪能力。平台面向集团高管、产运研设计，集成现金大盘、排行榜等功能，为高效决策提供直观的数据支撑。

技术栈：React + AntD + ECharts + Scss + qiankun + SSE
个人职责：

- 主导系统微前端架构改造，基于 qiankun 框架完成项目作为子应用接入主应用，系统 UV 累计增加400+。
- 负责短轮询接口升级为 SSE 长链接，实现数据分钟级动态追踪能力，网络请求数量减少70%+。
- 负责系统无感知升级部署及版本更新提示能力，并优化 CI/CD 流水线流程，实现系统上线不停服。
- 分析页面长时间运行后卡顿问题，通过 Memory 统计，优化后内存占用下降20%，保障系统性能及稳定性。



### 微前端架构选型：qiankun
为啥要选择微前端架构？微前端能解决什么问题？微前端对业务能产生什么价值？
### S
1. 打造大运营后台，统一数据产品入口，诚少多平台来换回切换的操作成本，提升用户使用效率
2. 组内一款数据产品用户期望能简化实时数据的获取难度，帮助数据盯盘；
### T
1. 目的：嵌入PC数据平台，增加流量入口
2. 提高用户使用效率，减少操作成本
### A
1. 确定项目融合方案
   1. mpa，割裂且多方改造成本都很大，微前端技术栈无关，框架版本无关；独立开发、独立部署。微应用仓库独立，前后端可独立开发，部署完成后主框架自动完成同步更新；渐进式选代升级和迁移。
2. 技术选型：主流的微前端方案
   1. iframe：简单接入，但通信困难，资源加载慢。
   2. microApp： 基于 Web Components，尚未成热。
   3. qiankun：基于 single-spa 封装，提供了更加开箱即用的 API，资源预加载；js隔离；样式隔离；
   4. HTML Entry接入方式，接入微应用像使用iframe 一样简单。
### R
1. 通过其他平台引流，用户U数增长400+
2. 沉淀其他子应用接入步骤及注意点，预计并帮助CRH接入人力减少30%

## SSE 升级
### 为什么选择 SSE
- S 用户数量增多，短轮询对服务器压力大，且实时性不能保证
- T 开级通信通道，实现分钟级实时刷新，仅接收服务器发送的数据
- A 技术选型：
- 长轮询、sse、websocket这三个通信方案，兼容性，轮询>长轮询>SSE>WebSocket，性能：
WebSocket>SSE>长轮询>轮询
### SSE 优势
1. 单向性，SSE 是单向的，数据只能从服务器发送到客户端
2. 简单易用：SSE 的 API 相对简单，易于理解和使用。
3. 持久化连接：SSE 使用持久化的连接，大幅降低服务器压力
4. 跨平台兼容性：SSE 基于 HTTP 协议，因此可以在各种浏览器和平台上使用，具有较好的兼容性。
### 结果
1. 推数准确性提升，实现分钟级更新实时数据，
2. 有效减少无效轮询，整体减少无效请求50%
### SSE 实现
客户端可以通过以下方式实现 SSE：
1. 检测支持性：检查浏览器是否支持 SSE，通过window. EventSource 来检测。
2. 创建连接；new EventSource 对象，指定 URL、允许携带cookie，用 withCredentials。
3. 监听事件；onopen建立连接，通过 onmessage、onerror、close 来接收和处理服务器发送的消息，处理错误，关闭连接

## 如何实现系统无感知升级部署
### S
- 每次上线会在群里发布上线公告，会出现10mins的服务不可用时间，实际对用户来说可能半个小时都不会访问系统
- 对于没看到公告的用户并不知道上线通知，没有刷新页面会导致菜单不可点击等问题
### T
1. 提高系统的可用率，简化上线流程，增加更新提醒
  - 调研公司部署平台的编排部署功能，实现灰度发布
  - 配置部署流程后，实现后续一键上线。自动分批部署，部署时自动摘除负载，滚动部署，挂载负载，
  - 部署完成后，用户出现系统版本不一致就会提示用户刷新系统
2. 增加系统版本更新提醒，每次部署时将生成系统静态资源版本，通过 html-webpack-plugin在html中增加meta标识，通过短轮询判断客户端静态资源是否最新，以提示用户刷新系统
  - 实现一键部署编排配置，保证系统上线过程中服务一直可用
  - 上线可感知，防止一直访问老系统
  - 无感知更新方案推广至其他系统，解决上线系统不可用问题

### 难点
1. 主应用改成人Oss中获取静态资源，修改vite的base后，本地配host访问预发实例，报错子应用跨域
**解决方法：**
1. 通过nginx的jstassets的代理解决子应用本地运行时的跨域问题
base: isProd ? /istassets/${ossConfig.bucketName}/${bpmVersion.version} ： /assets : env. VITE_PUBLIC_PATH,
1. 发现子应用的静态资源地址不对，导致新的报错
2. 通过设置子应用public-path设置方法，通过它来指定应用程序中所有资源的基础路径。

**知识点**
1. giankun用vite的base属性做什么，原理是什么
> Qiankun 使用vite的base属性来指定子应用在浏览器中的基础路径。原理是在加载子应用时，使用base属性来指定子应用的根路径，这样浏览器就能正确地解析子应用的路由和资源路径。这样可以确保子应用能够正确地加载和运行，同时也能够避免路由冲突和资源路径错误的问题。
1. 报错是由于浏览器的CORS策略导致的
2. 现象：主应用是version.jst.jd.com，使用qiankun基座，子应用是jkanban.jd,com,version的脚手架是vite，修改了base属性力cdn地址，导致子应用加载报错跨域
3. 解决方法：在子应用的服务器端进行CORs配置，允许来自基座应用的跨域请求。具体的配置方法可以参考你使用的服务器框架的文档。
另外，你还可以考虑将子应用的资源部署到与基座应用相同的域名下，或者使用反向代理等方式来解决跨域问题。这样子应用就可以正常加载并避免跨域错误。

## 浏览器内存古用
### S
1.长时间运行页面时，越来越卡，内存占用高，估计存在内存泄漏
### T
客户端内存压力：浏览器可能因为持续接收和处理数据而导致内存占用增加。
开启多页面，内存占用速度更快，可能存在内存泄漏
### A
先通过 Performance 判断是否存在内存泄漏
再通过 memory的快照对比来查找详细内存没有被回收的代码
内存泄漏可能的原因 https://juejin.cn/post/6947841638118998029#heading:6
- 控制台的打印
- 全局变量：sse返回的对象被挂载在window对象上，导致无法垃圾回收
- 定时器没有销毁
- 闭包使用不当，没有被正确回收
- 分离的DOM节点


## 容器内存使用率
### S
- 监控排查中发现容器内存使用率接近100%，容器重启后快速下降，之后逐渐上升，并在100%附近徘徊，###T
- 客户端内存压力：浏览器可能因为持续接收和处理数据而导致内存占用增加。
- 开启多页面，内存占用速度更快，可能存在内存泄漏
### A
容器
- 首先，用户相关的内存种类有 RSS 和 容器内存（Page cache）
- Page cache这块内存占用上升很快，是linux系统为了增加IO效率而做的性能优化，优先将文件放进内存中，直到内存被耗尽，通过杀死进程来释放内存，尽管docker对防止误杀做了优化，还是存在重要进程被误杀的情况，需要处理。
- 通过堡经机查着容器状态，发现日志进程活跃，日志I0操作导致】配置日志定时清理
- 通过 Memory分析，内存泄漏问题不是主要原因
### R
- 有效预防系统隐患，保证平台的平稳运行

## 系统容错机制
1. 前端实时监控和日志平台
   1. 监控小工具，实时统计在线人数以及长连接个数。对一些应急情况增加报警，如达到瓶颈时进行降级限流策略，限制能打开的长连接个数，查询时间等
  2，完普的日志排查（ELK架构）以及埋点统计（mysq1的埋点看板）
2. 兜底保障策略
  1. 重试机制。断网重试、失败重试后自动重连3次
  2. 自动消除占资源的长连接。如 3h 无操作断开连接
  3. 限流。设置大促降级措施，限制查数范围
1. 掉数问题如何处理，停数后增加提示及动画

## 日志治理
前端在nginx层采用ELK方案将接口日志统一存入ES，用于排查问题、简单的研发及产品数据分析产品侧需求将子午线数据转存到ES或mysql，满足产品在京想或者easybi分析埋点数据做用户分析具体：
- dockerfile脚本中新增filebeat.yml配置文件和启动filebeat命令
- nginx配置文件新增获取返回值代码块，通过1ua脚本获取响应体的数据
- filebeat.yml指定采集日志的路径及输出
### 埋点
- 背景：公司内部的埋点平台，我们无法实时获取埋点详细数据，需要隔天才能知道系统数据，且对于埋点数据的管理较麻烦，没办法使用sql语言操作
- 操作：通过接口发送请來，将点击效据等存入mysql，通过公司内部的低代码平台配置查询接口，显示埋点数据，例如访问记录、请求参数，页面Pv和UV
- 错误监测：componentDidCatch中捕获组件中的js错误